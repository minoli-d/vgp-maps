---
title: "Species Distribution Maps"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = 'asis')
# knitr::opts_knit$set(root.dir = "/global/scratch/users/minoli/maps")
knitr::opts_knit$set(root.dir = "~/Desktop/vgp-maps")
library(ggplot2)
library(sf)
library(terra)
library(dplyr)
library(rnaturalearth)
library(rnaturalearthdata)
library(viridis)
library(raster)
library(sp)
library(stringr)
```

```{r}
df <- read.csv("results/summary/all_species_summary.csv", stringsAsFactors = FALSE)
dir.create("results/summary/plots", recursive=TRUE, showWarnings=FALSE)

```

```{r}
# Goode Homolosine outline
lats <- c(90:-90, -90:0, 0:-90, -90:0, 0:-90, -90:0, 0:-90, -90:90, 90:0, 0:90, 90)
longs <- c(rep(180, 181),
           rep(c(80.01, 79.99), each = 91),
           rep(c(-19.99, -20.01), each = 91),
           rep(c(-99.99, -100.01), each = 91),
           rep(-180, 181),
           rep(c(-40.01, -39.99), each = 91),
           180)

goode_outline_ll <- st_polygon(list(cbind(longs, lats))) %>% st_sfc(crs = 4326)
crs_goode <- "+proj=igh +datum=WGS84 +no_defs"
goode_outline   <- st_transform(goode_outline_ll, crs_goode)
bb   <- st_bbox(goode_outline)
xlim <- bb[c("xmin","xmax")] * c(1.1,1.1)
ylim <- bb[c("ymin","ymax")] * c(1.1,1.1)
goode_encl_rect <- st_polygon(list(rbind(c(xlim[1], ylim[1]),
                                         c(xlim[2], ylim[1]),
                                         c(xlim[2], ylim[2]),
                                         c(xlim[1], ylim[2]),
                                         c(xlim[1], ylim[1])))) %>% st_sfc(crs = crs_goode)
goode_without <- st_difference(goode_encl_rect, goode_outline)
world_ll   <- ne_countries(scale="medium", returnclass="sf")
world_goode<- st_transform(world_ll, crs_goode)
ocean_goode<- st_difference(goode_encl_rect, st_union(world_goode))

tmpl_goode <- terra::rast(extent = terra::ext(xlim[1], xlim[2], ylim[1], ylim[2]),
                          resolution = 10000, crs = crs_goode)
```

## Sampling Map

```{r}
sampling_pts <- st_as_sf(df %>% filter(!is.na(lon))
                         , coords = c("lon", "lat"), crs = 4326) %>%
  st_transform(crs_goode)

p1 <- ggplot() +
  geom_sf(data = ocean_goode, fill="white", color=NA) +
  geom_sf(data = world_goode, fill="grey85", color="white", size=0.2) +
  geom_sf(data = goode_without, fill="white", color=NA) +
  geom_sf(data = sampling_pts, color="red3", size=1, shape=21, fill=NA) +
  geom_sf(data = goode_outline, fill=NA, color="gray70", size=0.5) +
  theme_minimal() +
  labs(title="All Sampling Locations")

ggsave("results/summary/plots/global_sampling_locations.png", p1)

p1
```

## Range Centroid Map

```{r}
centroids <- st_as_sf(df %>% filter(!is.na(centroid_lon)), 
                      coords = c("centroid_lon", "centroid_lat"), crs = 4326) %>%
  st_transform(crs_goode)

p2 <- ggplot() +
  geom_sf(data = ocean_goode, fill="white", color=NA) +
  geom_sf(data = world_goode, fill="grey85", color="white", size=0.2) +
  geom_sf(data = goode_without, fill="white", color=NA) +
  geom_sf(data = centroids, color="royalblue3", size=1, shape=21, fill=NA) +
  geom_sf(data = goode_outline, fill=NA, color="gray70", size=0.5) +
  theme_minimal() +
  labs(title="All Range Centroids")

ggsave("results/summary/plots/global_centroid_locations.png", p2)
p2
```

## Heatmap of Distributions

```{r, error=TRUE}
goode_rasters <- as.character(df$raster_path_goode)
goode_rasters <- goode_rasters[file.exists(goode_rasters)]

# sum_raster_goode <- rast(goode_rasters[1])
# 
# for (rpath in goode_rasters[-1]) {
#   r <- rast(rpath)
#   sum_raster_goode <- sum_raster_goode + r
# 
#   sum_raster_goode <- writeRaster(
#     sum_raster_goode,
#     filename = "results/summary/plots/sum_goode_test.tif",
#     overwrite = TRUE,
#     wopt = list(datatype = "INT4U", gdal = c("COMPRESS=DEFLATE"))
#   )
# }

sum_raster_goode <- rast("results/summary/plots/sum_goode_test.tif")

r_df <- as.data.frame(sum_raster_goode, xy = TRUE, na.rm = FALSE)
names(r_df)[3] <- "count"

p3 <- ggplot() +
  geom_sf(data = ocean_goode, fill="white", color=NA) +
  geom_sf(data = world_goode, fill="grey85", color="white", size=0.2) +
  geom_raster(data = r_df, aes(x=x, y=y, fill=count)) +
  scale_fill_viridis_c(name="Count", na.value="white") +
  geom_sf(data = goode_without, fill="white", color=NA) +
  geom_sf(data = goode_outline, fill=NA, color="gray70", size=0.5) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(title="Species Range Density", x=NULL, y=NULL)

ggsave("results/summary/plots/global_range_heatmap.png", p3)
p3
```

## Individual Species Maps

```{r, eval=FALSE}
for (i in seq_len(nrow(df))) {
  sp      <- df$scientific_name[i]
  print(sp)
  sp_sane <- gsub(" ", "_", sp) 
  sp_dir  <- file.path("results/species", sp_sane)
  dir.create(sp_dir, recursive = TRUE, showWarnings = FALSE)

  sp_pts <- tibble(
    name = c("Sampling", "Centroid"),
    lon  = c(df$lon[i], df$centroid_lon[i]),
    lat  = c(df$lat[i], df$centroid_lat[i])
  ) %>% filter(!is.na(lon) & !is.na(lat))

  sp_sf <- if (nrow(sp_pts) > 0) {
    st_as_sf(sp_pts, coords = c("lon", "lat"), crs = 4326) %>%
      st_transform(crs_goode)
  } else NULL

  r_df <- NULL
  if (!is.na(df$raster_path_goode[i]) && file.exists(df$raster_path_goode[i])) {
    r    <- rast(df$raster_path_goode[i])
    r_df <- as.data.frame(r, xy = TRUE, na.rm = TRUE)
    names(r_df)[3] <- "presence"
    r_df <- filter(r_df, presence > 0)
  }

  p <- ggplot() +
    geom_sf(data = ocean_goode, fill = "white", color = NA) +
    geom_sf(data = world_goode, fill = "grey85", color = "white", size = 0.2) +
    geom_sf(data = goode_without, fill="white", color=NA) +
    geom_sf(data = goode_outline, fill = NA, color = "gray70", size = 0.5) +
    { if (!is.null(r_df)) geom_tile(data = r_df, aes(x = x, y = y), fill = "chartreuse3", alpha = 0.5) } +
    { if (!is.null(sp_sf)) geom_sf(data = sp_sf, aes(color = name), size = .75, shape = 21, fill = NA) } +
    scale_color_manual(values = c("Sampling" = "red3", "Centroid" = "royalblue3")) +
    theme_minimal() +
    theme(plot.title = element_text(size = 10)) +
    labs(title = paste(sp, ":"), x=NULL, y=NULL, color=NULL)

  ggsave(file.path(sp_dir, paste0(sp_sane, "_distribution_map.png")),
         p, width = 5, height = 3, dpi = 300)
}
```

```{r,  results='asis'}

df_prioritized <- df %>%
  mutate(
    priority = case_when(
      # 1. both sampling and centroid missing
      missing_sampling_location_flag & missing_range_flag ~ 1L,
      
      # 2. sampling exists but invalid
      (!missing_sampling_location_flag) & 
        (outside_range_flag | vague_location_flag | zoo_flag | domesticated_flag) ~ 2L,
      
      # 3. sampling unusable + centroid available
      (missing_sampling_location_flag | vague_location_flag | outside_range_flag |
         zoo_flag | domesticated_flag) & !missing_range_flag ~ 3L,
      
      # 4. missing range but has usable sampling
      missing_range_flag & !missing_sampling_location_flag ~ 4L,
      
      # 5.
      TRUE ~ 5L
    )
  ) %>%
  dplyr::select(scientific_name, iucn_name, assessment_id, category, criteria,
         pop_trend, locations, year_published, latest, gbif_synonyms,
         iucn_synonyms, lineage, english_name,
         accession_number_for_main_haplotype, assemblyInfo_biosample_accession,
         assemblyInfo_biosample_geoLocName, assemblyInfo_biosample_latLon,
         assemblyInfo_comments, geo_location, latlon, lat, lon,
         vague_location_flag, missing_sampling_location_flag,
         raster_path_ea, raster_path_goode, centroid_lon, centroid_lat,
         outside_range_flag, missing_range_flag, zoo_flag,
         domesticated_flag, priority) %>%
  arrange(priority, scientific_name) 

write.csv(df_prioritized, "results/summary/all_species_prioritized.csv", row.names = FALSE)

for (i in seq_len(nrow(df_prioritized))) {
  sp      <- df_prioritized$scientific_name[i]
  sp_sane <- gsub(" ", "_", sp)
  sp_dir  <- file.path("results/species", sp_sane)
  img_path <- file.path(sp_dir, paste0(sp_sane, "_distribution_map.png"))

  if (file.exists(img_path)) {
    desc <- paste0(
      "\n\n### Species: ", sp, "\n\n",
      "**Biosample:** ", df_prioritized$assemblyInfo_biosample_accession[i], "  \n",
      "**Taxon:** ", df_prioritized$lineage[i], "  \n",
      "**Priority:** ", df_prioritized$priority[i],"  \n",
      "**Flags:** ",
  ifelse(isTRUE(df_prioritized$outside_range_flag[i]) & !isTRUE(df_prioritized$zoo_flag[i]), "Outside Range; ", ""),
  ifelse(isTRUE(df_prioritized$vague_location_flag[i]), "Vague Location; ", ""),
  ifelse(isTRUE(df_prioritized$zoo_flag[i]), "Zoo Sample; ", ""),
  ifelse(isTRUE(df_prioritized$domesticated_flag[i]), "Domesticated; ", ""),
  ifelse(df_prioritized$missing_range_flag[i], "Missing Range; ", ""),
  ifelse(isTRUE(df_prioritized$missing_sampling_location_flag[i]), "Missing Sampling Location; ", "")
)
    cat(desc, "\n")
    cat("![](../species/", sp_sane, "/", sp_sane, "_distribution_map.png)", sep = "")
  }
}

```
